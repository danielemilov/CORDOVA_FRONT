import{j as a}from"./ui-NZYliEti.js";import{b as $,r as d,u as D}from"./vendor-_1ZOfwzY.js";import{d as x,u as P,f as z,I as h,j as B,k as N,l as _,m as O,n as U,o as Y,p as w,q}from"./index-B-zzZdsT.js";import{p as F,i as H,f as b,b as W,c as G,e as J}from"./utils-VUVtOQ0U.js";const K=x(q)`
  margin-left: 10px;
`,Q=x(w)`
  color: ${c=>c.$unread?"#000":"#666"};
  font-weight: ${c=>c.$unread?"bold":"normal"};
  font-size: 14px;
  line-height: 1.4;
`,V=x(w)`
  font-size: 12px;
  color: #999;
  white-space: nowrap;
`,X=x(N)`
  text-align: center;
  font-size: 16px;
  color: #666;
  margin-top: 20px;
`,Z=({onSelectConversation:c,filter:C,unreadMessages:v,currentUser:u})=>{const[E,f]=d.useState([]),[S,I]=d.useState(!0),[k,j]=d.useState(null),o=P(),L=D(),m=d.useCallback(async()=>{var e,s,r;try{I(!0),j(null);const t=await z.get("/api/messages/conversations");Array.isArray(t.data)?(f(t.data),console.log("PLACE1")):(console.error("Unexpected response format:",t.data),j("Received unexpected data format from server"))}catch(t){console.error("Error fetching conversations:",t);const n=((s=(e=t.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to fetch conversations";j(n),((r=t.response)==null?void 0:r.status)===401&&L.push("/login")}finally{I(!1)}},[L]);d.useEffect(()=>{m()},[m]),d.useEffect(()=>{if(o){const e=t=>{console.log("PLACE2"),f(n=>{const l=n.findIndex(i=>i._id===t._id);if(l!==-1){const i=[...n];return i[l]=t,i.sort((M,p)=>{var g,A;return new Date(((g=p.lastMessage)==null?void 0:g.createdAt)||0)-new Date(((A=M.lastMessage)==null?void 0:A.createdAt)||0)})}else return[t,...n]})},s=({conversationId:t})=>{console.log("PLACE3"),f(n=>n.map(l=>l._id===t?{...l,unreadCount:0}:l))},r=t=>{console.log("PLACE4"),f(n=>n.map(i=>i._id===t.conversationId?{...i,lastMessage:t,unreadCount:i.unreadCount+(t.sender._id!==u.id?1:0)}:i).sort((i,M)=>{var p,g;return new Date(((p=M.lastMessage)==null?void 0:p.createdAt)||0)-new Date(((g=i.lastMessage)==null?void 0:g.createdAt)||0)}))};return o.on("update conversation",e),o.on("message read",s),o.on("new message",r),()=>{o.off("update conversation",e),o.off("message read",s),o.off("new message",r)}}},[o,u.id]);const R=d.useCallback(e=>{if(!e)return"";try{const s=F(e);return H(s)?b(s,"h:mm a"):W(s)?"Yesterday":G(s)?b(s,"EEEE"):J(s,{addSuffix:!0})}catch(s){return console.error("Error formatting last message time:",s),""}},[]),y=d.useMemo(()=>E.filter(e=>e.participants&&e.participants.length>0&&(e.participants.some(s=>s.username&&s.username.toLowerCase().includes(C.toLowerCase()))||e.lastMessage&&e.lastMessage.content&&e.lastMessage.content.toLowerCase().includes(C.toLowerCase()))),[E,C]),T=d.useCallback(async e=>{o&&o.connected?o.emit("mark as read",{conversationId:e._id},r=>{r?console.error("Error marking messages as read:",r):(console.log("PLACE5"),f(t=>t.map(n=>n._id===e._id?{...n,unreadCount:0}:n)))}):console.warn("Socket is not connected. Unable to mark messages as read.");const s=e.participants.find(r=>r._id!==u.id);c(s)},[o,c,u]);return S?a.jsx(h,{className:"ion-padding",children:a.jsx(B,{})}):k?a.jsxs(h,{className:"ion-padding ion-text-center",children:[a.jsx(N,{color:"danger",children:k}),a.jsx(_,{onClick:m,children:"Retry"})]}):y.length===0?a.jsxs(h,{className:"ion-padding ion-text-center",children:[a.jsx(X,{children:"No conversations found"}),a.jsx(_,{onClick:m,children:"Refresh"})]}):a.jsx(h,{children:a.jsx(O,{children:y.map(e=>{var t;const s=e.participants.find(n=>n._id!==u.id);if(!s)return console.warn("Other user not found in conversation:",e),null;const r=e.unreadCount>0&&((t=e.lastMessage)==null?void 0:t.sender._id)!==u.id;return a.jsxs(U,{onClick:()=>T(e),button:!0,children:[a.jsx(Y,{slot:"start",children:a.jsx("img",{src:s.photo||"https://via.placeholder.com/150",alt:s.username})}),a.jsxs(w,{children:[a.jsx("h2",{children:s.username}),a.jsx(Q,{$unread:r,children:e.lastMessage?e.lastMessage.content:"No messages yet"})]}),a.jsxs("div",{slot:"end",children:[r&&a.jsx(K,{color:"danger",children:e.unreadCount}),a.jsx(V,{children:e.lastMessage&&R(e.lastMessage.createdAt)})]})]},e._id)})})})},ne=$.memo(Z);export{ne as default};
//# sourceMappingURL=Conversations-VVDddu_t.js.map
