import{R as z,d as b,r as C,N as H,a6 as P,O as B,j as u,a7 as E,a8 as U,a9 as $,aa as O,ab as W,ac as q,ad as G,ae as N,af as J}from"./index-BmB6lFxD.js";import{t as f,e as K,g as X,m as Y,d as A,h as Q,j as V,p as Z,i as v,f as F,a as ee,b as te}from"./parseISO-4zpO-cv8.js";function T(e,t){const s=f(e),i=f(t),n=s.getTime()-i.getTime();return n<0?-1:n>0?1:n}function se(e,t){const s=f(e),i=f(t),n=s.getFullYear()-i.getFullYear(),m=s.getMonth()-i.getMonth();return n*12+m}function ne(e){return t=>{const i=(e?Math[e]:Math.trunc)(t);return i===0?0:i}}function ae(e,t){return+f(e)-+f(t)}function re(e){const t=f(e);return t.setHours(23,59,59,999),t}function oe(e){const t=f(e),s=t.getMonth();return t.setFullYear(t.getFullYear(),s+1,0),t.setHours(23,59,59,999),t}function ie(e){const t=f(e);return+re(t)==+oe(t)}function ce(e,t){const s=f(e),i=f(t),n=T(s,i),m=Math.abs(se(s,i));let D;if(m<1)D=0;else{s.getMonth()===1&&s.getDate()>27&&s.setDate(30),s.setMonth(s.getMonth()-n*m);let r=T(s,i)===-n;ie(f(e))&&m===1&&T(e,i)===1&&(r=!1),D=n*(m-Number(r))}return D===0?0:D}function le(e,t,s){const i=ae(e,t)/1e3;return ne(s==null?void 0:s.roundingMethod)(i)}function de(e,t,s){const i=Q(),n=(s==null?void 0:s.locale)??i.locale??K,m=2520,D=T(e,t);if(isNaN(D))throw new RangeError("Invalid time value");const r=Object.assign({},s,{addSuffix:s==null?void 0:s.addSuffix,comparison:D});let I,p;D>0?(I=f(t),p=f(e)):(I=f(e),p=f(t));const l=le(p,I),L=(X(p)-X(I))/1e3,d=Math.round((l-L)/60);let j;if(d<2)return s!=null&&s.includeSeconds?l<5?n.formatDistance("lessThanXSeconds",5,r):l<10?n.formatDistance("lessThanXSeconds",10,r):l<20?n.formatDistance("lessThanXSeconds",20,r):l<40?n.formatDistance("halfAMinute",0,r):l<60?n.formatDistance("lessThanXMinutes",1,r):n.formatDistance("xMinutes",1,r):d===0?n.formatDistance("lessThanXMinutes",1,r):n.formatDistance("xMinutes",d,r);if(d<45)return n.formatDistance("xMinutes",d,r);if(d<90)return n.formatDistance("aboutXHours",1,r);if(d<Y){const M=Math.round(d/60);return n.formatDistance("aboutXHours",M,r)}else{if(d<m)return n.formatDistance("xDays",1,r);if(d<A){const M=Math.round(d/Y);return n.formatDistance("xDays",M,r)}else if(d<A*2)return j=Math.round(d/A),n.formatDistance("aboutXMonths",j,r)}if(j=ce(p,I),j<12){const M=Math.round(d/A);return n.formatDistance("xMonths",M,r)}else{const M=j%12,w=Math.trunc(j/12);return M<3?n.formatDistance("aboutXYears",w,r):M<9?n.formatDistance("overXYears",w,r):n.formatDistance("almostXYears",w+1,r)}}function ue(e,t){return de(e,V(e),t)}const fe=b(J)`
  margin-left: 10px;
`,he=b(N)`
  color: ${e=>e.$unread?"#000":"#666"};
  font-weight: ${e=>e.$unread?"bold":"normal"};
  font-size: 14px;
  line-height: 1.4;
`,me=b(N)`
  font-size: 12px;
  color: #999;
  white-space: nowrap;
`,ge=b($)`
  text-align: center;
  font-size: 16px;
  color: #666;
  margin-top: 20px;
`,Me=({onSelectConversation:e,filter:t,unreadMessages:s,currentUser:i})=>{const[n,m]=C.useState([]),[D,r]=C.useState(!0),[I,p]=C.useState(null),l=H(),L=P(),d=C.useCallback(async()=>{var a,o,g;try{r(!0),p(null);const c=await B.get("/api/messages/conversations");Array.isArray(c.data)?(m(c.data),console.log("PLACE1")):(console.error("Unexpected response format:",c.data),p("Received unexpected data format from server"))}catch(c){console.error("Error fetching conversations:",c);const h=((o=(a=c.response)==null?void 0:a.data)==null?void 0:o.message)||"Failed to fetch conversations";p(h),((g=c.response)==null?void 0:g.status)===401&&L.push("/login")}finally{r(!1)}},[L]);C.useEffect(()=>{d()},[d]),C.useEffect(()=>{if(l){const a=c=>{console.log("PLACE2"),m(h=>{const y=h.findIndex(x=>x._id===c._id);if(y!==-1){const x=[...h];return x[y]=c,x.sort((k,S)=>{var _,R;return new Date(((_=S.lastMessage)==null?void 0:_.createdAt)||0)-new Date(((R=k.lastMessage)==null?void 0:R.createdAt)||0)})}else return[c,...h]})},o=({conversationId:c})=>{console.log("PLACE3"),m(h=>h.map(y=>y._id===c?{...y,unreadCount:0}:y))},g=c=>{console.log("PLACE4"),m(h=>h.map(x=>x._id===c.conversationId?{...x,lastMessage:c,unreadCount:x.unreadCount+(c.sender._id!==i.id?1:0)}:x).sort((x,k)=>{var S,_;return new Date(((S=k.lastMessage)==null?void 0:S.createdAt)||0)-new Date(((_=x.lastMessage)==null?void 0:_.createdAt)||0)}))};return l.on("update conversation",a),l.on("message read",o),l.on("new message",g),()=>{l.off("update conversation",a),l.off("message read",o),l.off("new message",g)}}},[l,i.id]);const j=C.useCallback(a=>{if(!a)return"";try{const o=Z(a);return v(o)?F(o,"h:mm a"):ee(o)?"Yesterday":te(o)?F(o,"EEEE"):ue(o,{addSuffix:!0})}catch(o){return console.error("Error formatting last message time:",o),""}},[]),M=C.useMemo(()=>n.filter(a=>a.participants&&a.participants.length>0&&(a.participants.some(o=>o.username&&o.username.toLowerCase().includes(t.toLowerCase()))||a.lastMessage&&a.lastMessage.content&&a.lastMessage.content.toLowerCase().includes(t.toLowerCase()))),[n,t]),w=C.useCallback(async a=>{l&&l.connected?l.emit("mark as read",{conversationId:a._id},g=>{g?console.error("Error marking messages as read:",g):(console.log("PLACE5"),m(c=>c.map(h=>h._id===a._id?{...h,unreadCount:0}:h)))}):console.warn("Socket is not connected. Unable to mark messages as read.");const o=a.participants.find(g=>g._id!==i.id);e(o)},[l,e,i]);return D?u.jsx(E,{className:"ion-padding",children:u.jsx(U,{})}):I?u.jsxs(E,{className:"ion-padding ion-text-center",children:[u.jsx($,{color:"danger",children:I}),u.jsx(O,{onClick:d,children:"Retry"})]}):M.length===0?u.jsxs(E,{className:"ion-padding ion-text-center",children:[u.jsx(ge,{children:"No conversations found"}),u.jsx(O,{onClick:d,children:"Refresh"})]}):u.jsx(E,{children:u.jsx(W,{children:M.map(a=>{var c;const o=a.participants.find(h=>h._id!==i.id);if(!o)return console.warn("Other user not found in conversation:",a),null;const g=a.unreadCount>0&&((c=a.lastMessage)==null?void 0:c.sender._id)!==i.id;return u.jsxs(q,{onClick:()=>w(a),button:!0,children:[u.jsx(G,{slot:"start",children:u.jsx("img",{src:o.photo||"https://via.placeholder.com/150",alt:o.username})}),u.jsxs(N,{children:[u.jsx("h2",{children:o.username}),u.jsx(he,{$unread:g,children:a.lastMessage?a.lastMessage.content:"No messages yet"})]}),u.jsxs("div",{slot:"end",children:[g&&u.jsx(fe,{color:"danger",children:a.unreadCount}),u.jsx(me,{children:a.lastMessage&&j(a.lastMessage.createdAt)})]})]},a._id)})})})},pe=z.memo(Me);export{pe as default};
